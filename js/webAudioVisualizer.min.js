(function(){AudioVisualizer=function(a){this.context=a.context?a.context:new AudioContext,this.divID=a.divID||'defaultAudioVisualizerID',this.type=a.type||'Oscilloscope',this.WIDTH=a.width||400,this.HEIGHT=a.height||220,this.fftSize=a.fftSize||2048,this.panelSize=a.panelSize||100,this.topSize=a.topSize||20,this.bottomSize=a.bottomSize||20,this.leftSize=a.leftSize||20,this.panelColor=a.panelColor||'rgb(15, 15, 15)',this.panelTextColor=a.panelTextColor||'rgb(0, 200, 0)',this.backgroundColor=a.backgroundColor||'rgba(0, 40, 0, 0.5)',this.strokeStyle=a.strokeStyle||'rgb(0, 200, 0)',this.fillStyle=a.fillStyle||'rgb(0, 200, 0)',this.params={yScaleVolume:1,xScaleVolume:200,maxXScaleVolume:400,precisionVolume:2,yScaleFrequencies:10,nbOfBarsFrequencies:50,xScaleFrequencies:1,yScaleOscilloscope:50,xScaleOscilloscope:50},this.analyser,this.canvasCtx,this.dataArray,this.bufferLength,this.frameCount=0,this.volumeArray=[],this.panel,this.width=this.WIDTH-this.panelSize-this.leftSize,this.height=this.HEIGHT-this.topSize-this.bottomSize,this.freqAxisLegend='Axis:1000Hz / tick',this.freeze=!1,this.maxNbOfBars=0,this.init()},AudioVisualizer.prototype.connectAndDraw=function(a,b){a.connect(this.analyser),b&&this.analyser.connect(b),this.draw()},AudioVisualizer.prototype.init=function(){this.analyser=this.context.createAnalyser(),this.analyser.fftSize=this.fftSize,this.analyser.smoothingTimeConstant=0.3,this.bufferLength=this.analyser.frequencyBinCount,this.maxNbOfBars=Math.min(this.width/2,this.bufferLength),'defaultAudioVisualizerID'==this.divID&&$('body').append('<div id="defaultAudioVisualizerID"></div>');let a=$('#'+this.divID);a.height(this.HEIGHT),a.width(this.WIDTH),a.css('display','inline-block'),a.css('border','1px solid black'),a.css('backgroundColor',this.panelColor),a.css('position','relative'),a.addClass('webAudioVisualizer'),a.append('<div style="position:absolute;width:'+this.width+'px;text-align:center;margin:auto;color:'+this.panelTextColor+';"><b>'+this.type+'</b></div>'),'Frequency'==this.type?a.append('<div style="position:absolute;bottom:0px;width:'+this.width+'px;color:'+this.panelTextColor+';">'+this.freqAxisLegend+'</div>'):a.append('<div style="position:absolute;bottom:0px;width:'+this.width+'px;color:'+this.panelTextColor+';"></div>'),a.append('<div style="position:absolute;top:0px;width:'+this.leftSize+'px;height:'+this.HEIGHT+'px;color:'+this.panelTextColor+';"></div>');let b=document.createElement('canvas');this.canvasCtx=b.getContext('2d'),b.width=this.width,b.height=this.height,b.style.cssText='position:absolute;top:'+this.topSize+'px;left:'+this.leftSize+'px;',a.append(b);let c='<div id = "'+this.divID+'Panel" class="panel" style=" display:inline-block;position:absolute;right:0px; width:'+this.panelSize+'px; height:'+this.HEIGHT+'px;"></div>';a.append(c),this.addControls(c)},AudioVisualizer.prototype.draw=function(){if(!this.freeze){requestAnimationFrame(AudioVisualizer.prototype.draw.bind(this));this.dataArray=new Uint8Array(this.bufferLength),this.canvasCtx.fillStyle=this.backgroundColor,this.canvasCtx.fillRect(0,0,this.WIDTH,this.HEIGHT),this.canvasCtx.lineWidth=2,this.canvasCtx.strokeStyle=this.strokeStyle,this.canvasCtx.beginPath(),'Volume'==this.type?this.drawVolume():'Frequency'==this.type?this.drawFrequencies():'Oscilloscope'==this.type&&this.drawOscilloscope()}},AudioVisualizer.prototype.addControls=function(){let b=this,c=$('#'+this.divID+'Panel'),e=this.HEIGHT/10,f=(this.HEIGHT-e)/3;c.append('<button id="'+this.type+'Freeze" style="position:absolute;left:10px;top:'+(e/2+3*f-20)+'px;">Freeze</button>'),$('#'+this.type+'Freeze').click(function(){b.freeze=!b.freeze,b.draw()}),'Volume'==this.type&&(c.append(this.addControl('yScale','yScaleVolume',e/2,1,10)),c.append(this.addControl('Memory','xScaleVolume',e/2+f,3,this.params.maxXScaleVolume))),'Frequency'==this.type&&(c.append(this.addControl('Resolution','nbOfBarsFrequencies',e/2,4,this.maxNbOfBars)),c.append(this.addControl('Zoom','xScaleFrequencies',e/2+f,1,10))),'Oscilloscope'==this.type&&(c.append(this.addControl('yScale','yScaleOscilloscope',e/2,1,200)),c.append(this.addControl('Zoom','xScaleOscilloscope',e/2+f,1,100)))},AudioVisualizer.prototype.addControl=function(a,b,c,e,f){let g=this,k=$('<div style="position:absolute; top:'+c+'px;"></div>');k.append('<p style="position:absolute;left:5px;margin:0px;padding:0px;color:'+this.panelTextColor+'">'+a+'</p>');let l=g.params[b],m='style="position:absolute; left:5px;top:15px;width:'+(this.panelSize-10)+'px"',n=$('<input id="'+a+'Slider" class="slider" '+m+'type="range" min="'+e+'" max="'+f+'" step="1" value="'+l+'"/>');return n.change(function(){g.params[b]=parseFloat($(this).val()),'xScaleVolume'==b&&(g.volumeArray=g.volumeArray.slice(0,g.params[b]))}),k.append(n),k},AudioVisualizer.prototype.drawVolume=function(){this.analyser.getByteFrequencyData(this.dataArray);let a=this.getAverageVolume(this.dataArray),b=this.height-this.height*this.params.yScaleVolume*a/100,c=this.params.xScaleVolume;this.frameCount++,this.frameCount>=this.params.precisionVolume&&(this.frameCount=0,this.volumeArray.push(b),this.volumeArray.length>c&&this.volumeArray.shift()),this.canvasCtx.moveTo(0,this.height/2);for(let e=1;e<c;e++)this.canvasCtx.moveTo((e-1)*this.width/c,this.volumeArray[e-1]),this.canvasCtx.lineTo(e*this.width/c,this.volumeArray[e]);this.canvasCtx.stroke()},AudioVisualizer.prototype.drawFrequencies=function(){this.analyser.getByteFrequencyData(this.dataArray);let a=this.params.nbOfBarsFrequencies,b=this.params.xScaleFrequencies,c=this.width/a,e,f=0,g=Math.ceil(this.bufferLength/(a*b)),k=Math.max.apply(null,this.dataArray),l=0,m=[];for(let n=0;n<a;n++){e=0;for(let o=0;o<g;o++)e+=this.dataArray[n*g+o];e/=g,e>l&&(l=e),m.push(e)}for(let o,n=0;n<a;n++)o=0.85*this.height*m[n]/255,o*=k/l,this.canvasCtx.fillStyle=this.fillStyle,this.canvasCtx.fillRect(f,this.height-10-o,c,o),f+=c+1;this.canvasCtx.font='12px Arial';for(let n=1e3;n<this.context.sampleRate/2;n+=1e3)this.canvasCtx.fillText('|',(c+1)*this.getIndexFromFrequencies(n,g)-c/2,this.height)},AudioVisualizer.prototype.drawOscilloscope=function(){this.analyser.getByteTimeDomainData(this.dataArray);let a=0;for(let e=0;e<this.fftSize-this.width;e++)if(128>=this.dataArray[e]&&128<this.dataArray[e+1]){a=e;break}let b=0,c=Math.round(10*this.fftSize/(2*this.width))/10;for(let e=0;b<this.width;e++){b+=this.params.xScaleOscilloscope/50,e>this.bufferLength&&(e-=this.bufferLength);const f=this.params.yScaleOscilloscope/50*(this.dataArray[e+a]-128)/256*this.height+this.height/2;0===e?this.canvasCtx.moveTo(b,f):this.canvasCtx.lineTo(b,f)}this.canvasCtx.stroke()},AudioVisualizer.prototype.getAverageVolume=function(a){let c,b=0,e=a.length;for(let f=0;f<e;f++)b+=a[f]/255*a[f]/255;return c=100*Math.sqrt(b/e*(2048/this.fftSize)),c},AudioVisualizer.prototype.getIndexFromFrequencies=function(a,b){let c=this.context.sampleRate/this.fftSize;return c*=b,a/c}})();